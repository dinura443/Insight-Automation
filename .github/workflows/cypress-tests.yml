name: insight cypress-tests

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Create .env file
        run: |
          echo "USERNAME=${{ secrets.USERNAME }}" >> .env
          echo "PASSWORD=${{ secrets.PASSWORD }}" >> .env
          echo "DASHBOARD_NAME=${{ secrets.DASHBOARD_NAME }}" >> .env
          echo "ROOT_DIR=${{ secrets.ROOT_DIR }}" >> .env
          echo "DOWNLOAD_DIR=${{ secrets.DOWNLOAD_DIR }}" >> .env
          echo "FIXTURES=${{ secrets.FIXTURES }}" >> .env
          echo "DASHBOARD_INSTANCE1=${{ secrets.DASHBOARD_INSTANCE1 }}" >> .env
          echo "DASHBOARD_INSTANCE2=${{ secrets.DASHBOARD_INSTANCE2 }}" >> .env
          echo "DASHBOARD_UI=${{ secrets.DASHBOARD_UI }}" >> .env
          echo "BACKUP=${{ secrets.BACKUP }}" >> .env
          echo "INSTANCE1_LOGIN=${{ secrets.INSTANCE1_LOGIN }}" >> .env
          echo "INSTANCE2_LOGIN=${{ secrets.INSTANCE2_LOGIN }}" >> .env
          echo "INSTANCE1_DASHBOARD=${{ secrets.INSTANCE1_DASHBOARD }}" >> .env
          echo "INSTANCE2_DASHBOARD=${{ secrets.INSTANCE2_DASHBOARD }}" >> .env

      - name: Create Required Directories
        run: |
          mkdir -p ${{ env.DOWNLOAD_DIR }}
          mkdir -p ${{ env.FIXTURES_DIR }}
          mkdir -p ${{ env.BACKUP_DIR }}
          mkdir -p ${{ env.INSTANCE1_DASHBOARD_DIR }}
          mkdir -p ${{ env.INSTANCE2_DASHBOARD_DIR }}

      - name: Validate .env File
        run: |
          if [ ! -f .env ]; then
            echo ".env file is missing!"
            exit 1
          fi
          grep -q "DOWNLOAD_DIR=" .env || { echo "Missing DOWNLOAD_DIR"; exit 1; }
          grep -q "FIXTURES_DIR=" .env || { echo "Missing FIXTURES_DIR"; exit 1; }

      - name: Run Cypress Tests
        run: npx cypress run
        continue-on-error: true